# Rate Limit 처리 흐름도

## 전체 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                         사용자 인터페이스                          │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  [메시지 생성] 버튼                                         │   │
│  │  - 활성/비활성 상태                                         │   │
│  │  - 남은 시간 표시                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Progress Bar                                            │   │
│  │  ████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ 25%     │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  에러 메시지 & 카운트다운                                   │   │
│  │  "45초 후 자동으로 재시도 가능합니다"                        │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    React 컴포넌트 (클라이언트)                     │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  State Management                                        │   │
│  │  - rateLimitUntil: number | null                        │   │
│  │  - remainingTime: number                                │   │
│  │  - isGenerating: boolean                                │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  useEffect Hooks                                         │   │
│  │  1. localStorage 체크 (mount 시)                         │   │
│  │  2. 1초마다 카운트다운 업데이트                            │   │
│  │  3. 0초 도달 시 자동 해제                                 │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         localStorage                            │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Key: ai_generate_rate_limit                            │   │
│  │  Value: 1706012345678 (타임스탬프)                        │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Key: ai_predict_rate_limit                             │   │
│  │  Value: 1706012345678 (타임스탬프)                        │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      API Routes (서버)                           │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  /api/ai/generate                                        │   │
│  │  - 요청 처리                                              │   │
│  │  - 429 에러 처리                                          │   │
│  │  - retryAfter 반환                                       │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        OpenAI API                               │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Rate Limit 체크                                          │   │
│  │  - 요청 수 제한                                           │   │
│  │  - 토큰 수 제한                                           │   │
│  │  - 429 에러 반환                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 상세 처리 흐름

### 1. 정상 요청 흐름

```
사용자 클릭
    ↓
Rate Limit 체크 (localStorage)
    ↓
[제한 없음]
    ↓
isGenerating = true
    ↓
API 요청 (/api/ai/generate)
    ↓
OpenAI API 호출
    ↓
[성공 200]
    ↓
메시지 생성 완료
    ↓
localStorage 정리 (기존 rate limit 삭제)
    ↓
isGenerating = false
    ↓
성공 토스트 표시
```

### 2. Rate Limit 발생 흐름

```
사용자 클릭 (여러 번)
    ↓
API 요청 (반복)
    ↓
OpenAI API 호출
    ↓
[429 Too Many Requests]
    ↓
서버: retryAfter = 60 반환
    ↓
클라이언트: 429 에러 수신
    ↓
limitUntil = Date.now() + (60 * 1000)
    ↓
localStorage.setItem('ai_generate_rate_limit', limitUntil)
    ↓
setRateLimitUntil(limitUntil)
    ↓
setRemainingTime(60)
    ↓
버튼 비활성화
    ↓
에러 메시지 표시
    ↓
Progress Bar 표시
```

### 3. 카운트다운 흐름

```
useEffect 시작 (rateLimitUntil 변경 시)
    ↓
setInterval 생성 (1초마다)
    ↓
┌─────────────────────────────┐
│  Interval 콜백 (매초 실행)    │
│  ↓                          │
│  now = Date.now()           │
│  ↓                          │
│  remaining = (limitUntil - now) / 1000  │
│  ↓                          │
│  [remaining > 0]            │
│  ↓                          │
│  setRemainingTime(remaining)│
│  ↓                          │
│  UI 업데이트                 │
│  - 버튼 텍스트               │
│  - Progress Bar             │
│  - 경고 메시지               │
└─────────────────────────────┘
    ↓
[remaining <= 0]
    ↓
localStorage.removeItem('ai_generate_rate_limit')
    ↓
setRateLimitUntil(null)
    ↓
setRemainingTime(0)
    ↓
setError(null)
    ↓
버튼 활성화
    ↓
성공 토스트 표시
    ↓
clearInterval
```

### 4. 페이지 새로고침 흐름

```
페이지 로드
    ↓
useEffect 실행 (mount 시)
    ↓
checkRateLimit()
    ↓
storedLimit = localStorage.getItem('ai_generate_rate_limit')
    ↓
[storedLimit 존재]
    ↓
limitTime = parseInt(storedLimit)
    ↓
now = Date.now()
    ↓
[limitTime > now] (아직 제한 중)
    ↓
setRateLimitUntil(limitTime)
    ↓
remainingTime = (limitTime - now) / 1000
    ↓
setRemainingTime(remainingTime)
    ↓
버튼 비활성화 상태로 렌더링
    ↓
카운트다운 시작 (useEffect)
```

## 타임라인 예시

```
시간    |  이벤트                          |  상태
--------|----------------------------------|---------------------------
00:00   | 사용자가 버튼 클릭 (1회)          | 정상 처리
00:05   | 메시지 생성 완료                  | 성공
00:06   | 사용자가 "다시 생성" 클릭 (2회)   | 정상 처리
00:11   | 메시지 생성 완료                  | 성공
00:12   | 사용자가 "다시 생성" 클릭 (3회)   | 정상 처리
00:17   | 메시지 생성 완료                  | 성공
00:18   | 사용자가 "다시 생성" 클릭 (4회)   | 정상 처리
00:23   | OpenAI Rate Limit 발생!          | 429 에러
00:23   | localStorage 저장                | limitUntil = 00:23 + 60초
00:23   | 버튼 비활성화                     | "60초 후 가능"
00:24   | 카운트다운 업데이트               | "59초 후 가능"
00:25   | 카운트다운 업데이트               | "58초 후 가능"
...     | ...                              | ...
01:22   | 카운트다운 업데이트               | "1초 후 가능"
01:23   | Rate Limit 만료!                 | 자동 해제
01:23   | localStorage 삭제                | 정리
01:23   | 버튼 활성화                       | "메시지 생성"
01:23   | 성공 토스트 표시                  | "이제 다시 생성 가능"
01:24   | 사용자가 버튼 클릭                | 정상 처리
```

## 컴포넌트 생명주기

```
┌─────────────────────────────────────────────────────────────┐
│  Component Mount                                            │
│  ├─ useEffect #1 (mount 시 1회)                            │
│  │  └─ localStorage 체크                                   │
│  │     └─ 기존 rate limit 복원                             │
│  │                                                          │
│  ├─ useEffect #2 (rateLimitUntil 변경 시)                  │
│  │  └─ setInterval 시작                                    │
│  │     └─ 1초마다 카운트다운                                │
│  │                                                          │
│  └─ useEffect #3 (selectedMessage 변경 시)                 │
│     └─ API 요청                                            │
│        └─ Rate limit 체크                                  │
└─────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Component Update (매초)                                    │
│  ├─ remainingTime 감소                                      │
│  ├─ 버튼 텍스트 업데이트                                     │
│  └─ Progress Bar 업데이트                                   │
└─────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Component Unmount                                          │
│  └─ clearInterval (메모리 누수 방지)                         │
└─────────────────────────────────────────────────────────────┘
```

## 에러 처리 계층

```
Layer 4: UI (사용자 인터페이스)
         ↓
         - 버튼 비활성화
         - 에러 메시지 표시
         - Progress Bar 표시
         - 토스트 알림
         ↓
Layer 3: React Component (상태 관리)
         ↓
         - rateLimitUntil 상태
         - remainingTime 상태
         - useEffect 훅
         ↓
Layer 2: localStorage (지속성)
         ↓
         - Rate limit 정보 저장
         - 페이지 새로고침 대응
         ↓
Layer 1: API Route (서버)
         ↓
         - 429 에러 처리
         - retryAfter 반환
         ↓
Layer 0: OpenAI API (외부 서비스)
         ↓
         - Rate limit 적용
         - 429 에러 발생
```

## 주요 함수 호출 순서

### generateMessages() 함수

```javascript
1. generateMessages() 호출
   ↓
2. Rate limit 체크
   if (rateLimitUntil && Date.now() < rateLimitUntil) {
     → toast.error() 표시
     → return (종료)
   }
   ↓
3. setIsGenerating(true)
   ↓
4. fetch('/api/ai/generate', {...})
   ↓
5. response 체크
   if (response.status === 429) {
     ↓
     5-1. retryAfter 추출
     ↓
     5-2. limitUntil 계산
     ↓
     5-3. localStorage.setItem()
     ↓
     5-4. setRateLimitUntil()
     ↓
     5-5. setRemainingTime()
     ↓
     5-6. throw Error
   }
   ↓
6. [성공 시]
   ↓
   6-1. localStorage.removeItem()
   ↓
   6-2. setRateLimitUntil(null)
   ↓
   6-3. setMessages()
   ↓
   6-4. toast.success()
   ↓
7. setIsGenerating(false)
```

## 데이터 흐름

```
┌──────────────┐
│   사용자      │
└──────┬───────┘
       │ 클릭
       ↓
┌──────────────────────────┐
│  generateMessages()      │
│  - Rate limit 체크        │
│  - API 요청              │
└──────┬───────────────────┘
       │
       ↓
┌──────────────────────────┐
│  localStorage            │
│  - 읽기: 기존 limit 체크  │
│  - 쓰기: 새 limit 저장    │
│  - 삭제: limit 해제       │
└──────┬───────────────────┘
       │
       ↓
┌──────────────────────────┐
│  React State             │
│  - rateLimitUntil        │
│  - remainingTime         │
│  - isGenerating          │
└──────┬───────────────────┘
       │
       ↓
┌──────────────────────────┐
│  UI 렌더링               │
│  - 버튼 상태             │
│  - 텍스트 표시           │
│  - Progress Bar          │
└──────────────────────────┘
```
